# JavaScriptnoの問題
JavaScriptの不備が原因となる脆弱性について

# DOM Based XSS
## 概要
JavaScriptによる処理の不備が原因でXSSとなる場合があり、DOM Based XSSと呼ばれている。
近年JavaScriptによる処理が相対的に増えてきており、DOM Based XSSがあるアプリケーションも増えてきている。

## 脆弱性が生まれる原因
- DOM操作の際に外部から指定されたHTMLタグなどが有効になってしまう機能を用いている
- 外部から指定されたJavaScriptが動くevalなどの機能を用いている
- XMLHttpRequestのURLが未検証である
- location.hrefやsrc属性、href属性のURLが未検証である

HTMLタグなどが有効になってしまう機能(関数やプロパティ)の例
- document.write() / document.writeln()
- innerHTML / outerHTML
- jQueryのhtml()
- jQueryのjQuery()、$()

evalインジェクションの原理でJavaScriptが動く機能
- eval()
- setTimeout() / setInterval()
- Functionコンストラクタ
外部からコントロール可能な値を上記に設定することにより、意図しないJavaScriptが実行されることになる。

URLにjavascriptスキームやvbscriptスキームが指定できるとJavaScriptが実行される機能
- JavaScriptのlocation.href
- a要素のhref属性やiframe要素のsrc属性など

## 対策
DOM Based XSSの原因は、外部から指定したHTMLタグ文字列がHTMLの要素に変換されてしまうことや、eval関数などに外部からの値を渡すことが原因なので、以下のいずれかにより文字がそのまま表示されるようにすることで対策になる。
### 適切なDOM操作あるいは記号のエスケープ
innerHTMLやdocument.writeの使用を避け、DOM操作によりテキスト要素を追加するか、textContentプロパティを使用することでDOM Based XSSを防ぐことができる。
例: innerHTMLプロパティをtextContentプロパティに置き換えることにより、DOM Based XSSは対策される。
document.writeについてはDOM操作では代替できないので、document.writeの使用をやめるか、HTMLエスケープによる対策となる。
### eval、setTimeout、Functionコンストラクタなどの引数に文字列形式で外部からの値を渡さない
evalやFunctionコンストラクタは本質的に危険なので避けるべきだが、どうしても使わなければならない場合は、外部からの値を英数字に限定する方法などで対策する。
### URLのスキームをhttpかhttpsに限定する
location.hrefやsrc属性やhref属性など、URLをとる属性値はスキーマがhttpかhttpsであることを確認する必要がある。
### jQueryのセレクタは動的生成しない
$()の引数を動的生成すると、セレクタの意味を変更させられる可能性があり、危険である。
$()の引数は原則として動的生成しないことが推奨される。
例えばfindメソッドを用いることで、動的にHTML要素を生成されることはなくなる。
しかし、findメソッドを用いた場合でもセレクタの構造を替えることはできてしまうので、値の検証も必要である。
既に$()の引数を動的に生成しているアプリケーションがあり緊急に修正しなければならない場合は、引数を検証するか、整数に変換する方法もある。
### 最新のライブラリを用いる
新しいjQueryは対策されており、使うだけでセレクタによるDOM Based XSSは防げるが、予防としてアプリケーション側でも引数は動的生成しないことが推奨される。
### XMLHttpRequestのURLを検証する
XMLHttpRequestのURLを外部から自由に指定できると、仮にXSSにならなくてもオープンリダイレクトと似た問題となり、画面の内容を改変されるなどの問題が生じる。
このため、XMLHttpRequestのURLは外部から指定できないようにすることが確実な対策だが、どうしてもURLを可変にしたい場合は、固定のテーブルを用いる方法が確実である。

# Webストレージの不適切な使用
## Webストレージとは
近年のブラウザでは、クッキーよりも高機能なストレージ(保管庫)として、Webストレージを用意している。
クッキーは自動的にリクエスト毎にサーバに送信されるが、WebストレージはJavaScriptから書き込み、読み出し、削除ができるだけでサーバへの送信は自動的には行われない。
Webストレージには、localStorageとsessionStorageの2種類がある。
- localストレージ
  - 永続的なストレージ
- sessionStorage
  - ブラウザのタブが開いている間だけ自保持されるストレージ
  -
### Webストレージには何を保存してよいか
WebストレージはJavaScriptにより読み書きできるストレージであり、JavaScriptからのアクセスを禁止することはできません。
そのため、Webアプリケーションにクロスサイトスクリプティング脆弱性があると、Webストレージの内容は漏洩することになる。
この点がhttpOnly属性をつけたクッキーとは異なる特性である。
Webストレージの内容がXSSにより漏洩しやすいという特性から、重要な情報はWebストレージには保存しないようにするべきであり、
具体的にはパスワード、個人情報などは直接Webストレージには保存せず、必要になる度にサーバに問い合わせるようにする。

## Webストレージの不適切な利用例
Webストレージ自体は同一オリジンポリシーの制限があり、それを緩める手段もないことから、Webストレージ単体では脆弱性が入り込む余地はあまりない。
したがってWebストレージの使い方で問題が生じるシナリオは、他の機能との組み合わせにおいて起きる。
具体例としては以下
- Webストレージに秘密情報を保存していた
- Webストレージに保存した情報が、XSSやpostMessageにより漏洩する
- WebストレージがXSSやpostMessage経由で改ざんされる
- Webストレージを経由したDOM Based XSS

# postMessage呼び出しの不備
## postMessageとは
irameやwindow.openで開いたウィンドウなど、複数のウィンドウが異なるオリジンで強調して動作する環境で、メッセージやデータのやり取りを行う汎用的な仕組みがpostMessageである。

## 対策
postMessageはもともと異なるオリジン間のメッセージ送受信を提供する仕組みなので、オリジンが想定のものかどうかのチェックはアプリケーション側の責任で実施する必要がある。
オリジンがどれでもよいサービスは例外だが、特定のオリジンとのメッセージを想定する場合は下記の両方を実施する。
- 送信先の確認
  - postMessageメソッドの第2引数に送信先のオリジンを指定することで、送信先オリジンが正しいことを確認することができる。
- 送信元の確認
  - onmessageイベントハンドラにて、event.orijinプロパティを確認する。

# オープンリダイレクト
オープンリダイレクト脆弱性が混入するのはサーバ側の処理に限らず、JavaScriptの処理によっても混入する可能性がある。

## 対策
- リダイレクト先のURLを固定にする
- リダイレクト先URLを直接指定せず番号などで指定する
処理を複雑にしないこと。

# まとめ
従来からDOM Based XSSという形でJavaScriptの実装による脆弱性は知られていたが、その後JavaScriptで使える機能が増えたことと、JavaScriptの利用が広がったことに起因して、JavaScriptの実装不備による脆弱性はWebの大きな脅威となっている。
まずはJavaScript自体の機能やライブラリの仕様を正しく把握した上で、対策し、脆弱性を作りこまない実装が重要である。
