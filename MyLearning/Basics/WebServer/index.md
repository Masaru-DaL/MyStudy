# WebServer

## 1. WebServerの歴史

参考: [Wikipedia WebServer](https://ja.wikipedia.org/wiki/Web%E3%82%B5%E3%83%BC%E3%83%90)

| 年数               | 出来事                                                  |
| ---------------- | ---------------------------------------------------- |
| 1989年            | CERNに在籍していたティム・バーナーズ=リーがWebシステムの素案を目に見える形で提案         |
| 1990年11月         | World Wide Webをより具体化した提案書を発表                         |
| 1990年11月13日      | Webシステムの開発が開始                                        |
| 1990年12月~1991年1月 | クリスマス休暇中に現在のWebサーバ群の基になるHTTPサーバ「CERN httpd」と各種ツールを作成 |
| 1991年8月          | WWWとWebサーバのデビュー プロジェクト成果の要約をニュースグループに投稿              |
| 1992年            | CERN httpdに続く2番目の実装とるなる「NCSA HTTPd」を開発               |
| 1993年            | 画像も表示できるウェブブラウザNCSA Mosaicを開発                                                     |

* **1991年8月にWWWとWebサーバがデビューした**
* **1992~1993年で一般に急速に広まった**
この時点でのWebサーバの主役は「CERN httpd」「NCSA HTTPd」だったが、改修が進まないという不満が募り、「NCSA HTTPd」に修正を加えるためのパッチを集積するプロジェクトが始まった。そして、このプロジェクトに「**Apache Group**」という名前が付けられた。このプロジェクトでNCSA HTTPdのメンテを主目的としたNCSA HTTPdの派生版の「**Apache HTTP Server**」が誕生し、こちらに主役を移すことになった。

* 2015年時点のWebServerの市場
Apache(派生版含む): 4割
IIO(MicroSoft): 3割
nginx: 2割弱

## 2. Server と WebServer

Server ≒ WebServer
Sever, WebServer: ハードウェアを指す場合もあるし、ソフトウェアを指す場合もある
肌感的にはServer=ハードウェア, WebServer=ソフトウェアを指す感じはする。
基本的にWebサーバはソフトウェアを指すものとする。

### 2-1. WebServerとは

* Webサーバは**Webサイトを公開するため**に必要なもの。
いくら頑張ってWebアプリ、Webサイトを作ってもWebサーバがなければ公開できない。

* クライアントサーバモデルのサーバを指す

1. Webクライアント(ブラウザ)を使ってWebサイトにアクセスする
2. WebクライアントからのリクエストをWebサーバで受け取る
3. Webサーバは、リクエストに応じて「HTML」や「画像」などのデータを探す
4. Webサーバは、データをWebクライアントにデータをレスポンスする

* クライアントからのリクエストの種類によって動作が異なる
  + 静的ウェブサーバ
    - 静的コンテンツの場合はWebサーバでレスポンスを返す。
  + 動的ウェブサーバ
    - 動的コンテンツの場合はアプリケーションサーバに必要なデータをリクエストする。アプリケーションサーバから必要データを受け取った後、クライアントにデータをレスポンスする。

### 2-2. WebServerがリクエストを処理するプロセス

#### 2-2-1. WebServerはリクエストを返すためのファイルを格納する必要がある。

リクエスト/レスポンスで応答するものは全てファイルとして考える。

 1. HTML文書およびその関連資産である画像
 2. CSSスタイルシート
 3. JavaScriptファイル
 4. フォント
 5. 動画など
※**自分のコンピュータでも可能だがWebサーバに全てを格納したほうがはるかに便利であるため**。

#### 2-2-2. HTTP通信

* HTTPについて気をつける点

 1. **サーバはクライアントのHTTPリクエストに応答することだけができる**
 2. クライアント(ブラウザ)は、HTTPでファイルをリクエストする時にURLを示さなければならない
 3. サーバは全てのHTTPリクエストに応える必要がある。処理できない場合でもエラーメッセージを返す必要がある。

* Webサーバがリクエストを受信した時

1. サーバは最初にリクエストされたURLが既存にファイルに一致するかどうかをチェックする。
2. 一致するファイルがあった場合、ブラウザにファイルを送り返す。なかった場合、アプリケーションサーバが必要なファイルを作成する。
3. どちらの処理もできなかった場合、エラーメッセージ(404)をブラウザに返す。

#### 2-2-3. アプリケーションサーバ(APサーバ)

Webサーバがリクエストを処理する際に、リクエストに一致したファイルがなかった場合にアプリケーションサーバが必要なファイルを作成する。これは、動的コンテンツのリクエストに対応しているという事である。

参考: [Web3層構造 image](https://www.infraexpert.com/infogif/server41.gif)

> APサーバは**Webサーバからの要求を受けてプログラムを実行**したり、必要に応じて**DBサーバへの問い合わせや書き込み処理**をし、処理結果をWebサーバへ提供する役割を担っている。

## 3. WebServerの種類

よく使われるのは**Apache**, **Nginx**, **IIS**の3種類で、この3種類だけで全体の80％近くのシェアを占める。

参照: [W3Techs.com](https://w3techs.com/technologies/overview/web_server)

### 3-1. Apache

正式名称: **Apache HTTP Server**
イギリスのApacheソフトウェア財団が保持している。歴史的経緯は、1章を参照。

* OSS
* LinuxOSに採用されている
* マルチスレッド
  + 動的なコンテンツの処理に適していて、CGIやPHPなどに向いている
* 色々なアプリやソフトを利用する際に、比較的簡単な設定で済む
* 約20年間利用されていて、バージョンアップが続いているため、信頼性が高い
* メモリを多めに消費するので、アクセス増加によりメモリが足らなくなることもある

### 3-2. Nginx

読み方: **エンジンエックス**
アメリカのサンフランシスコに本社をかまえるNGINX, Inc.によって開発され、2002年に登場した比較的新しいWebサーバ。

* OSS
* 開発者にとても人気がある
* Apacheより速くて高負荷に強い
  + 設計段階からApacheが苦手な大容量データ配信や大量同時接続に耐えることを目的に作られたため
  + 同時接続数がApacheの10~100倍にも耐えられる(ノンブロッキングI/Oと非同期のイベント駆動アーキテクチャという仕組みによるもの)
* シングルスレッド
  + 静的コンテンツを扱うのに適する
  + キャッシュサーバ不要でHTMLや画像などをキャッシュできる
* CPUを使う作業に比較的弱い

### 3-3. IIS(Internet Information Services)

Windows用のWebサーバ機能のこと。WindowsNT 3.51のアドオンとして1995年に提供が開始された。Microsoft社が提供しているため、Windowsに特化している。

* OSSではない
* 操作はGUIで行う
  + Linuxなどのようにコマンドを扱う必要がない
* 動的なWebページを手軽に作成できるので、Webアプリケーションを効率よく開発できる
* 今回の3種類の中では比較的難易度は優しめで、初めて利用する人でも使いやすい

## 4. サーバの提供の種類

サーバ会社からサーバを借りる際のサービスの違いなどについて調べる。自分でWebサーバを構築することも出来るが、基本的にはサーバを提供するサービスを利用するものとする。

1. 物理サーバとして、**共有サーバ**と**専有サーバ**というサービス提供の違いがある。
2. 物理サーバ上に仮想的に作られたユーザごとの専用領域を**仮想専有サーバ(VPC)**と呼ぶ。
3. インターネット上で提供するコンピュータ機能を利用する仕組みを**クラウドコンピューティング**と言い、その中のサービスの1つで**クラウドサーバ**を提供している。

### 4-1. 共有サーバ/専有サーバ/仮想専有サーバ(VPS)の比較

|               | 共有サーバ                                  | 専有サーバ                                | 仮想専有サーバ(VPC)             |
| ------------- | -------------------------------------- | ------------------------------------ | ------------------------ |
| **特徴**        | 1台のサーバを複数のユーザで利用する                     | 1台のサーバを1人で専有して利用する                   | 1台のサーバを複数ユーザで利用する仮想専用サーバ |
| **メリット**      | <li>コストが安い</li><li>専門知識が不要</li>        | <li>リソースを専有できる</li><li>カスタマイズ可能</li> | <li>共有サーバより自由度が高い</li><li>専有サーバのようなスペックを安価に利用可能</li>                     |
| **デメリット**     | <li>自由度が低い</li><li>他のユーザの影響を受けやすい</li> | <li>コストがかかる</li><li>専門知識が必要</li>     | <li>専有サーバほど自由度がない</li><li>専門知識がある程度必要</li>                         |
| **向いている人・企業** | 個人利用・小規模企業                             | 上級者・大企業向け                            | 上級者、中規模企業向け                         |

### 4-2. クラウドサーバ

レンタルサーバと同様にネットワークを通じてサーバ会社からサーバを借り受けできるサービス。クラウドサーバは、インターネット上にある**仮想サーバ**の事を指す。

* クラウドを活用する利点

1. **わずか数分で仮想サーバを建てることができる**
ユーザテンプレートとして設定しておくと、同じサーバ環境をわずか数分で複製できる。サーバ構築の手間を大幅に軽減できる。
冗長化を考慮して複数台のサーバで運用する際や、開発から本番へ移行する場合に役立つ。

2. **コストが安い**
クラウドは初期費用が安く済む。(場合によってはかからない)従量制によって必要な分だけの支払いで済む。VPSと比べると高くなるとは思うが、カスタマイズ性などを考慮するとコストパフォーマンスが良いと言える。

3. **拡張性が高い**
急なアクセス増加によって負荷が増加するなどの対応が可能になる。オンプレミスの場合はスペックを上げるために再度サーバを構築し直す必要がある。

4. **バックアップ・BCP対策ができる**
クラウドサーバは国内外の堅牢なデータセンターで管理されているため、BCP(事業継続計画)対策が可能。障害の際にもデータが消失することがないように、バックアップの体制も整っているため、データを守るためにクラウドを活用するという利点がある。

* デメリットも存在する

1. 長期的なコスト
従量制はサイトやシステムが大きくなり、使用量が増えると高額になってくることがある。長期的に見ると自社でサーバを構築するよりも高コストになることがある。

2. セキュリティ対策や障害対応を委ねることになる
有事の際にはサーバの提供会社に任せることになる。自社で原因の追求やサーバの立ち上げ直しなどによる復旧作業は行えない。

#### 4-3. クラウドサーバとVPSの違い

|               | クラウドサーバ                                | VPS                                        |
| ------------- | -------------------------------------- | ------------------------------------------ |
| **共通部分**              | 仮想サーバ                                       | 仮想サーバ                                           |
| **使用可能なリソース** | <li>自由</li><br>契約解除することなく必要なリソースに変更が可能 | <li>固定</li><br>リソースを変更したい場合は一度契約を解除する必要がある |
| **契約台数**      | 複数台契約が可能                               | 1台契約                                       |
| **月額コスト**     | 重量課金(豊富な機能から取捨選択できる)                   | 月額固定料金(コストを抑えることが可能だが、機能は豊富ではない)           |
| **特徴**            | 急激なアクセス不可の応じたリソースの増減が可能                | 急なアクセス負荷時などに対応できない<br>前もってサーバの負荷を想定する必要がある |

## 5. プログラミング言語別 Webサーバの種類

1. pythonとgolangで実際にWebServerを建ててindex.htmlを表示させてみる。
2. 触った事のあるphpでもWebServerを建てられるのか調べてみる。

### 5-1. golang

1. 空のディレクトリを用意する。
2. `go mod init golang-webserver`
3. `static/index.html`を用意する。
4. `main.go`に以下のコードを記述する。

```go: main.go
package main

import (

	"log"
	"net/http"

)

func main() {

	/* ディレクトリを指定する */
	fs := http.FileServer(http.Dir("static"))
	/* /にアクセスがきたら指定したディレクトリのコンテンツを表示 */
	http.Handle("/", fs)

	log.Println("Listening...")
	http.ListenAndServe(":3000", nil)

}

```

```shell:
-> tree
.
├── go.mod
├── main.go
└── static

    └── index.html

-> go run main.go
2022/10/22 15:35:13 Listening...

```

### 5-2. Python

http.serverモジュールを利用する。
1. 空のディレクトリを用意する。
2. その中で`python -m http.server 8000`を叩く。
3. `http://localhost:8000`で立ち上げを確認。
4. ディレクトリ内にindex.htmlを配置すると、Webページが表示される。
golangより簡単。

```shell:
-> tree
.
└── index.html

-> python -m http.server 8000
Serving HTTP on :: port 8000 (http://[::]:8000/) ...

```

### 5-3. PHP

* PHP5.4.0から簡易WebServerを立ち上げる機能が追加された。
  + 「ビルドインウェブサーバー」

`.html` を読み込むために、例えば以下のように記述する。

```php:
<?php
  $filepath = $_SERVER["SCRIPT_NAME"];

  if( !preg_match( "/\.html$/", $filepath ) ){
    return false;
  }

  chdir( dirname( substr( $filepath, 1 ) ) );
  require_once( $filepath );
  return true;
?>
```

作業ディレクトリで上のファイルを明示的に指定して実行する。
 `php -S 127.0.0.1:8080 router.php`

phpの簡易ウェブサーバは、htmlファイル内にphpのスクリプトを記述したものは読み込めないみたい。なので、その場合はXAMPPなどでApacheを使うしかないみたい。

### 5-4. 言語別サーバの建て方のまとめ

1. 言語によって大分難易度(複雑さ)に違いがある。
2. pythonがすごいシンプルかつ簡単に建てられた。
   1. そもそもコマンドだけで建てられる
   2. ファイルを必要としていない
3. golangはファイルを用意して明示的に指定する分可読性は良いと感じた
4. phpは仕組みが追いついてないような気がした
   1. 構築するまでは面倒だが、XAMPPやDockerを使ってしまった方が早そうな気がした。
