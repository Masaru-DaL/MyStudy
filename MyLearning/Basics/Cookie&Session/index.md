- [1. CookieとSessionの概要](#1-cookieとsessionの概要)
  - [1-1. なぜCookieとSessionが存在するのか](#1-1-なぜcookieとsessionが存在するのか)
  - [1-2. CookieとSessionの関係](#1-2-cookieとsessionの関係)
- [2. Cookie](#2-cookie)
  - [2-1. Cookieの特徴](#2-1-cookieの特徴)
    - [2-1-1. そもそもCookieって何を指すの？](#2-1-1-そもそもcookieって何を指すの)
    - [2-1-2. Cookie発行までの流れ](#2-1-2-cookie発行までの流れ)
    - [2-1-3. ブラウザからサーバへ Cookieの送信について](#2-1-3-ブラウザからサーバへ-cookieの送信について)
    - [2-1-4. Cookieの取り扱い](#2-1-4-cookieの取り扱い)
- [3. Storage](#3-storage)
  - [3-1. ブラウザで保存する仕組みの種類](#3-1-ブラウザで保存する仕組みの種類)
  - [3-2. WebStorage](#3-2-webstorage)
    - [3-2-1. WebStorageの概要](#3-2-1-webstorageの概要)
    - [3-2-2. sessionStorage](#3-2-2-sessionstorage)
    - [3-2-3. localStorage](#3-2-3-localstorage)
    - [3-2-4. WebStorageの用途](#3-2-4-webstorageの用途)
  - [3-3. Cookieとの違いは？](#3-3-cookieとの違いは)
    - [3-3-1. 仕組み](#3-3-1-仕組み)
    - [3-3-2. 操作](#3-3-2-操作)
- [4. Session](#4-session)
  - [4-1. Sessionのイメージ](#4-1-sessionのイメージ)
  - [4-2. Session ブラウザとサーバのやり取り(関係)](#4-2-session-ブラウザとサーバのやり取り関係)

## 1. CookieとSessionの概要

### 1-1. なぜCookieとSessionが存在するのか

**HTTP通信がステートレスなプロトコルで「状態」を持てないため**
状態とは何を指すのか。
一例だが、ログインした後の状態とする。
ログインした後、ページを閉じて、開くとまたログインしなくてはいけないというのは面倒すぎる。これを解決してくれるのがCookieとSessionである。

### 1-2. CookieとSessionの関係

この2つの関係を間違えてはいけない。
**Cookieを使って、Session状態を保持する**。調べる前はこう思ってたが、あまり正しくない、というか詳しく説明出来ていない。

正しくは、**Cookieに保存されたセッションIDとサーバに保存されたセッションIDを照合し、保存されたセッション状態を取り出す**。の方が正しい言い方な気がする。

## 2. Cookie

正式名称は「HTTP Cookie」だが、単にCookieとも表記されるので、Cookieと表記されていたらHTTP Cookieのことだと思って良い。

Cookieとは、HTTPにおけるブラウザとサーバの間で用いられる**ウェブブラウザに保存された情報のこと**を指す。ユーザ識別やセッション管理を実現する目的などに利用される。

参照: [HTTP Cookie](https://ja.wikipedia.org/wiki/HTTP_cookie)

### 2-1. Cookieの特徴

勘違いしていたが、ログインしていなくてもCookieは発行されている。そこの所を理解する。

#### 2-1-1. そもそもCookieって何を指すの？

Cookieとは、情報を発行する仕組み・またはそのデータを指す。データを指す場合、それは**テキストファイル**である。そして、そこに格納できるデータは**どんな情報**でも格納できる。
しかし、**多くの場合は個人情報を保存している**という扱いをされる。

#### 2-1-2. Cookie発行までの流れ

1. ブラウザからWebサーバにアクセスする(初回アクセス時)
2. Webサーバはブラウザへ、**そのWebサーバ専用のCookieファイルを作成する**(ブラウザへ発行する)
3. 次回ブラウザがWebサーバへアクセスした際に、ブラウザは発行されたCookieをWebサーバへ送信する。
4. WebサーバはCookie情報を読み取る。この時、WebサーバにもブラウザのCookie情報は保存されているので、照らし合わせ、該当ブラウザと判断する。

#### 2-1-3. ブラウザからサーバへ Cookieの送信について

* Cookieは、サーバにアクセスする度に自動送信される。
という事は**ブラウザ側にデータを保存する仕組みがある**ということ。

* Cookieは受け取ったサーバにしか送らない。
ブラウザがCookieをサーバから受け取った後、**受け取ったサーバとは異なるWebサーバに対してはCookieを送らない**。

#### 2-1-4. Cookieの取り扱い

* ログインなどによってCookieの値は更新される場合もある。
* Cookieの値は有効期限が設けられている。
* ブラウザでCookieの仕組みを有効か無効か選ぶ事ができる。
* 便利な反面、Cookieの取り扱いに注意喚起を鳴らす声もある。

## 3. Storage

ブラウザからサーバへCookieを送信するが、ブラウザ側にCookieを保存しておく仕組みがあるという事がわかる。ブラウザ側でCookieを保存する仕組みについて調べる。

### 3-1. ブラウザで保存する仕組みの種類

* ブラウザでデータを保存する仕組みは、HTML4.1以前はCookieの仕組みしかなかった。
保存容量が4KBと少ないことや、全てのリクエストに対してサーバにデータを自動で送信するため、容量制限やセキュリティ対策に悩まされる事が多々あった。

* HTML5でCookieに代わるデータ保存の仕組みとして「**Web Storage**」と呼ばれる機能が利用できるようになった。
WebStorageには、ブラウザ側でKey-Value型でデータ保存する機能がある。また、WebStorageには「
 session Storage」と「localStorage」の2種類がある。CookieとWebStorageの大まかな違いは以下の表の通り。

|                | 別Windowでのデータ共有 | データの有効期限           | データ量の上限     | サーバへのデータ送信           | 操作  |
| -------------- | -------------- | ------------------ | ----------- | -------------------- | --- |
| Cookie         | ○              | 指定期限まで有効(任意に設定が可能) | 4KB         | サーバへアクセスするたびに毎回自動送信  | サーバサイド言語が多い(phpなど)    |
| sessionStorage | ×              | ウィンドウやタブを閉じるまで有効   | 1オリジンあたり5MB | 必要時のみスクリプトやフォームなどで送信 | JSのみ    |
| localStorage   | ○              | 永続的に有効             | 1オリジンあたり5MB | 必要時のみスクリプトやフォームなどで送信 | JSのみ    |

### 3-2. WebStorage

sessionStorageとlocalStorageの2種類があるが、一般的にlocalStorageを利用するケースが多いようです。

#### 3-2-1. WebStorageの概要

* WebStorageの仕様をサポートするブラウザでWebStorageAPIが使える。
WebStorageはJavaScriptのみで使用する事が出来るので、JavaScriptでこのAPIを使用するとWebStorageにアクセス出来るということ。

#### 3-2-2. sessionStorage

* ページをブラウザが開いている間に使用可能な[オリジン](https://riotz.works/articles/lopburny/2019/09/06/introduction-and-use-of-web-storage/#:~:text=%E3%80%8C%E3%82%AA%E3%83%AA%E3%82%B8%E3%83%B3%E3%80%8D%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6%E5%B0%91%E3%81%97%E5%85%B7%E4%BD%93%E7%9A%84%E3%81%AB%E8%AA%AC%E6%98%8E%E3%81%99%E3%82%8B%E3%81%A8%E3%80%81)ごとに区切られた保存領域を管理する。
* データはブラウザが閉じられるまで保存される。
* データがサーバに転送されることはない。
* ストレージの制限はCookieより大きい(最大5MB)

#### 3-2-3. localStorage

* ブラウザを閉じて、再び開いても持続する。
* 有効期限無しでデータを保存し、JavaScriptを介してクリアされる。または、ブラウザのキャッシュorローカルに保存したデータのクリアによってクリアされる。
* ストレージ制限は一番大きい。

#### 3-2-4. WebStorageの用途

ユースケースが多いものをピックアップする。

* 表示に関する各種設定情報(通知表示の有無など)
* ユーザの操作やアクションに関する情報(お気に入り、閲覧したページ、商品)
* クライアント側の使用状況をまとめてサーバに送信するための一時保管(エラーIDをまとめてログサーバに送信)
* サーバとのデータ不整合を防止するためのバージョン情報

### 3-3. Cookieとの違いは？

#### 3-3-1. 仕組み

* Cookieの仕組みは以下の通り
[2. Cookie](#2-cookie)

* WebStorageの仕組み
**サーバとの通信は関係なく、クライアント側(ブラウザ)でのみデータを保持する**。

#### 3-3-2. 操作

* 通常、CookieもWebStorageもJavaScriptで操作が可能。
CookieはXSSなどの対策でhttponly属性を付ける事でJavaScriptから操作することを無効化することができる。そうするとJavaScript経由で中身を見る事は出来なくなる。一方、WebStorageにそのような機能はない。

* Cookieの方が挙動を細かく制御することが可能。
Cookieクッキーには様々な属性(domain, path, 有効期限など)が用意されている。

## 4. Session

* セッションはブラウザを閉じるまで保存される。
* リンクなどでページを移動しても内容を保持できる。
* セッションが不要になった場合は、session_unsetファンクションを使ってセッションの内容を全て削除する。

### 4-1. Sessionのイメージ

ショッピングサイトを例に挙げると

* ユーザの識別
セッションIDで識別する

* 何を買ったか
セッション変数にデータをセットする。セッションが持続する間、保持することができる。

* ショッピングサイト内を移動する間は、サーバに保存されているセッション情報を逐次取り出して表示、更新する。

* 商品を追加したときにはセッション変数に追加、カートから削除した時にはセッション変数から削除する。

* セッションIDはCookieに記録される。
[参照: image](https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F62264%2F5f13c0d7-335c-8530-1351-84f89985f501.png?ixlib=rb-4.0.0&auto=format&gif-q=60&q=75&w=1400&fit=max&s=84116fc14499aa13e7974e7c9f3d9467)

### 4-2. Session ブラウザとサーバのやり取り(関係)

1. ブラウザからサーバにアクセスした際に、サーバにそのブラウザを識別する「セッションデータ」(=セッションID)が保存される。

2. サーバから、「サーバに保存されるセッションID」がブラウザに発行され、Cookieに記録される。

3. ブラウザに発行後は、ブラウザのCookieに記録されたセッションIDと、サーバに保存されたセッションIDとを照合し、ブラウザを識別してセッション内容を取り出す。
